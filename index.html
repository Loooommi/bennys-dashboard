<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Benny's - Gestion des T√¢ches</title>

    <style>
        *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
        body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial;background:linear-gradient(135deg,#000 0%,#1a1a1a 100%);min-height:100vh;padding:20px}
        .container{max-width:1200px;margin:0 auto;background:#fff;border-radius:20px;box-shadow:0 20px 60px rgba(0,0,0,.3);overflow:hidden}
        .header{background:linear-gradient(135deg,#ff0e0e8f 0%,#cc0000 100%);color:#fff;padding:25px;text-align:center}
        .header h1{font-size:28px;font-weight:700}
        .subtitle{opacity:.9}
        .status-bar{padding:15px 25px;background:#f8f9fa;border-bottom:2px solid #e9ecef;display:flex;justify-content:space-between}
        .status-dot{width:10px;height:10px;border-radius:50%;background:#dc3545}
        .status-dot.connected{background:#28a745}
        .main-content{padding:25px}
        .add-task-btn{width:100%;padding:15px;border:none;border-radius:10px;background:#28a745;color:#fff;font-size:16px;font-weight:600;margin-bottom:20px}
        .tasks-list{display:flex;flex-direction:column;gap:10px}
        .task-card{background:#f8f9fa;border:2px solid #dee2e6;border-radius:15px;padding:15px}
        .task-card.done{background:#d4edda;border-color:#28a745;opacity:.8}
        .task-header{display:flex;justify-content:space-between;align-items:center}
        .task-title.done{text-decoration:line-through;opacity:.6}
        .task-btn{border:none;border-radius:8px;padding:5px 10px;font-size:16px;cursor:pointer}
        .check-btn{background:#28a745}
        .uncheck-btn{background:#ffc107}
        .edit-btn{background:#17a2b8}
        .delete-btn{background:#dc3545}
        .alert{display:none;position:fixed;top:20px;left:50%;transform:translateX(-50%);padding:15px 30px;border-radius:10px;font-weight:600;z-index:2000}
        .alert.success{background:#28a745;color:#fff}
        .alert.error{background:#dc3545;color:#fff}
    </style>
</head>

<body>

<div class="container">
    <div class="header">
        <h1>üìã Gestion des T√¢ches</h1>
        <div class="subtitle">Benny's Garage</div>
    </div>

    <div class="status-bar">
        <div>
            <span class="status-dot" id="statusDot"></span>
            <span id="statusText">D√©connect√©</span>
        </div>
        <div id="lastSync">Aucune sync</div>
    </div>

    <div class="main-content">
        <button class="add-task-btn" onclick="openAddModal()">‚ûï Nouvelle t√¢che</button>
        <div class="tasks-list" id="tasksList"></div>
    </div>
</div>

<div class="alert" id="alertBox"></div>

<script>
const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxrJp452cyJCoBgc_fEVH0SRIX5FFWswa8C9bT7EwLH8MyJeLxa2c8Dlrh7zz5T-wWBiQ/exec';
const SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTrgS7cT2qYdeFv57KmBFmGC2OyjK0HmqLQuIRWX-oAAGphaNoxTowsPEz8wbNstQ52zqR-iiyQ_p77/pub?gid=918495740&single=true&output=csv';

let tasks = [];

window.onload = () => {
    const saved = localStorage.getItem('bennys_tasks');
    tasks = saved ? JSON.parse(saved) : [];
    displayTasks();
    connectSheet();
};

async function connectSheet() {
    try {
        const r = await fetch(SHEET_CSV_URL);
        if (r.ok) {
            document.getElementById('statusDot').classList.add('connected');
            document.getElementById('statusText').textContent = 'Connect√©';
            loadFromSheet();
        }
    } catch {}
}

async function loadFromSheet() {
    const res = await fetch(SHEET_CSV_URL);
    const text = await res.text();
    const lines = text.split('\n').slice(1);

    tasks = lines.filter(l => l.trim()).map(l => {
        const v = l.split(',');
        return { date:v[0], title:v[1], department:v[2], assignee:v[3], status:v[4] };
    });

    saveTasks();
    displayTasks();
}

function saveTasks() {
    localStorage.setItem('bennys_tasks', JSON.stringify(tasks));
}

function displayTasks() {
    const c = document.getElementById('tasksList');
    c.innerHTML = '';
    if (!tasks.length) {
        c.innerHTML = '<p>Aucune t√¢che</p>';
        return;
    }

    tasks.forEach((t,i) => {
        c.innerHTML += `
        <div class="task-card ${t.status==='done'?'done':''}">
            <div class="task-header">
                <div class="task-title ${t.status==='done'?'done':''}">${t.title}</div>
                <div>
                    <button class="task-btn ${t.status==='done'?'uncheck-btn':'check-btn'}" onclick="toggleTask(${i})">‚úì</button>
                    <button class="task-btn delete-btn" onclick="deleteTask(${i})">üóëÔ∏è</button>
                </div>
            </div>
            <small>${t.assignee} ‚Äì ${t.date}</small>
        </div>`;
    });
}

function toggleTask(i) {
    tasks[i].status = tasks[i].status === 'done' ? 'pending' : 'done';
    saveTasks();
    displayTasks();
}

function deleteTask(i) {
    if (!confirm('Supprimer cette t√¢che ?')) return;

    fetch(APPS_SCRIPT_URL, {
        method:'POST',
        mode:'no-cors',
        headers:{'Content-Type':'application/x-www-form-urlencoded'},
        body:new URLSearchParams({ action:'delete', row:i+2 })
    });

    tasks.splice(i,1);
    saveTasks();
    displayTasks();
    showAlert('T√¢che supprim√©e','success');
}

function showAlert(msg,type){
    const a=document.getElementById('alertBox');
    a.textContent=msg;
    a.className='alert '+type;
    a.style.display='block';
    setTimeout(()=>a.style.display='none',3000);
}
</script>

</body>
</html>
